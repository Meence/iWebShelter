<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - æˆ¿é—´ {{ room_id }}</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon.png" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZipåº“ï¼Œç”¨äºæ–‡ä»¶å¤¹å‹ç¼© -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        /* å…¨å±€box-sizingè§„åˆ™ï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ å®½åº¦è®¡ç®—å‡†ç¡® */
        * {
            box-sizing: border-box;
        }
        
        /* iOS18 é£æ ¼åŸºç¡€æ ·å¼ */
        body {
            background-color: #f5f5f7;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #d1d1d6;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            max-width: 1024px;
            margin: 0 auto;
            left: 0;
            right: 0;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .ios-btn {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®åŒ…è£…å™¨ï¼Œç¡®ä¿æ–‡ä»¶è¾“å…¥èƒ½è¦†ç›–æŒ‰é’® */
        .upload-button-wrapper {
            position: relative;
            display: inline-block;
            overflow: hidden;
        }
        /* ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯æ˜¾ç¤ºæ§åˆ¶ */
        .mobile-only {
            display: none;
        }
        .desktop-only {
            display: inline;
        }
        @media (max-width: 768px) {
            .mobile-only {
                display: inline;
            }
            .desktop-only {
                display: none;
            }
        }
        /* æ–‡ä»¶è¾“å…¥æ¡†è¦†ç›–æŒ‰é’®ï¼Œç¡®ä¿å¯ç‚¹å‡»åŒºåŸŸ */
        .upload-button-wrapper input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: -1;
        }
        
        /* ç¡®ä¿ä¸Šä¼ æŒ‰é’®å¯ä»¥è¢«ç‚¹å‡» */
        .upload-button-wrapper button {
            position: relative;
            z-index: 1;
        }
        
        .ios-btn-primary {
            background-color: #007aff;
            color: white;
        }
        
        .ios-btn-primary:hover {
            background-color: #0056b3;
        }
        
        .ios-btn-secondary {
            background-color: #f0f0f0;
            color: #333333;
        }
        
        .ios-btn-success {
            background-color: #34c759;
            color: white;
        }
        
        .ios-btn-success:hover {
            background-color: #28a745;
        }
        
        .ios-btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        /* å‰ªè´´æ¿å¡ç‰‡æ ·å¼ */
        .card {
            height: 240px; /* å›ºå®šå¡ç‰‡é«˜åº¦ */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* ç¡®ä¿é¡µé¢å¸ƒå±€æ­£ç¡®ï¼Œå†å²å¡ç‰‡åœ¨å‰ªè´´æ¿å¡ç‰‡ä¸‹æ–¹æ»šåŠ¨ */
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* ä¸»å†…å®¹å®¹å™¨ï¼Œç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½èƒ½æ­£ç¡®å±…ä¸­ */
        div.pb-8.px-4.max-w-4xl.mx-auto {
            margin: 0 auto;
            padding: 16px;
            max-width: 1024px;
            width: 100%;
            display: block;
            height: 100vh;
            overflow: hidden;
        }
        
        /* å‰ªè´´æ¿å¡ç‰‡æ ·å¼ï¼Œç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šæ­£ç¡®æ˜¾ç¤º */
        div.card.sticky {
            position: -webkit-sticky;
            position: sticky;
            top: 16px;
            margin-bottom: 16px;
            z-index: 10;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
            left: 0;
            right: 0;
        }
        
        /* å†å²è®°å½•å®¹å™¨æ ·å¼ï¼Œç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šæ­£ç¡®æ˜¾ç¤º */
        #historyContainer {
            margin-top: 12px; /* æ·»åŠ ç©ºéš™ï¼Œä¸å†å²è®°å½•å¡ç‰‡ä¹‹é—´çš„é—´è·ä¸€è‡´ */
            width: 100%;
            height: calc(100vh - 382px); /* å›ºå®šé«˜åº¦ï¼Œå‡å»é¡¶éƒ¨å›ºå®šå¡ç‰‡å’Œæ–°å¢é—´è· */
            overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch; /* å¯ç”¨å¹³æ»‘æ»šåŠ¨ */
            /* éšè—æ»šåŠ¨æ¡ */
            scrollbar-width: none; /* Firefox */
            position: relative;
            border-radius: 12px; /* æ·»åŠ åœ†è§’è¾¹æ¡†ï¼Œä¸å…¶ä»–å¡ç‰‡ä¿æŒä¸€è‡´ */
            background-color: transparent; /* èƒŒæ™¯é€æ˜ï¼Œä¸å½±å“å†…éƒ¨å¡ç‰‡ */
        }
        
        /* éšè—WebKitæµè§ˆå™¨çš„æ»šåŠ¨æ¡ */
        #historyContainer::-webkit-scrollbar {
            display: none;
        }
        
        /* å“åº”å¼è°ƒæ•´ï¼Œç¡®ä¿åœ¨ä¸åŒè®¾å¤‡ä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œ */
        @media (max-width: 640px) {
            /* ç§»åŠ¨ç«¯è°ƒæ•´å¡ç‰‡æ ·å¼ */
            .card {
                padding: 16px;
            }
        }
        
        /* ç¡®ä¿å†å²å¡ç‰‡åœ¨æ»šåŠ¨æ—¶ä¸ä¼šå½±å“å›ºå®šå¡ç‰‡ */
        .history-card {
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ‘¸ä½“éªŒ */
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1); /* ç‚¹å‡»é«˜äº® */
            transform: translateZ(0); /* ç¡¬ä»¶åŠ é€Ÿï¼Œå‡å°‘æŠ–åŠ¨ */
        }
        
        /* ç¡®ä¿ç¼–è¾‘å™¨åŒºåŸŸå æ®è¶³å¤Ÿç©ºé—´ */
        #customEditor {
            flex: 1;
        }
        
        /* å†å²è®°å½•å¡ç‰‡æ ·å¼ */
        .history-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .history-card:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* åˆ é™¤æŒ‰é’®æ ·å¼ - å³ä¸Šè§’åœ†å½¢ç°åº•Ã— */
        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #666666;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            padding: 0;
            z-index: 5;
        }
        
        .delete-btn:hover {
            background-color: #e0e0e0;
            color: #333333;
        }
        
        /* æ–‡ä»¶å›¾æ ‡æ ·å¼ï¼Œéšè—å®¹å™¨ï¼Œåªæ˜¾ç¤ºå›¾æ ‡ */
        .file-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            width: auto;
            height: auto;
            border-radius: 0;
        }
        
        /* è®¾ç½®æ–‡ä»¶å›¾æ ‡å¤§å°ï¼Œç¡®ä¿ç¾è§‚æ˜¾ç¤º */
        .file-icon img {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }
        
        /* å“åº”å¼è°ƒæ•´ï¼Œç¡®ä¿åœ¨æ‰‹æœºç«¯ä¹Ÿä¸æ˜¾ç¤ºå›¾æ ‡å®¹å™¨ */
        @media (max-width: 640px) {
            .file-icon {
                width: auto;
                height: auto;
                aspect-ratio: unset;
            }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 640px) {
            .card {
                padding: 16px;
            }
        }

        /* é€æ˜ç»¿è‰²é®ç½©åé¦ˆæ ·å¼ */
        .mask-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 255, 0, 0.2); /* é€æ˜ç»¿è‰² */
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .mask-overlay.active {
            opacity: 1;
        }
        .mask-overlay .text {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .upload-button-wrapper {
            position: relative;
        }
        
        /* æŒ‰é’®æ´»åŠ¨çŠ¶æ€ */
        .ios-btn:active {
            transform: scale(0.98);
        }
        
        /* æ–‡æœ¬ç¼–è¾‘å™¨ç„¦ç‚¹çŠ¶æ€ */
        #customEditor:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        /* å¯¼èˆªæ å®½åº¦è°ƒæ•´ */
        .navbar {
            width: 100%;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        /* ç¡®ä¿å¡ç‰‡å’Œå¯¼èˆªæ å®½åº¦å¯¹é½ */
        @media (min-width: 1024px) {
            .navbar {
                padding-left: calc((100% - 1024px) / 2);
                padding-right: calc((100% - 1024px) / 2);
            }
        }
        
        /* å†å²è®°å½•å¡ç‰‡æ–‡æœ¬é€‰æ‹© */
        .history-card p {
            user-select: text;
        }
    </style>
</head>
<body>
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="pb-8 px-4 max-w-4xl mx-auto">
        <!-- æœåŠ¡å™¨åç§°å®¹å™¨ -->
        <div class="relative mb-4 mt-1">
            <h1 class="text-3xl font-bold text-gray-800 text-center">{{ server_name }}</h1>
            <a href="https://github.com/Meence" target="_blank" class="text-gray-500 text-sm absolute right-0 bottom-0">@Meence</a>
        </div>
        <!-- åŒæ­¥å¡ç‰‡ - å›ºå®šåœ¨é¡¶éƒ¨ -->
        <div class="card sticky p-3 mb-6 top-2 z-10">
            <!-- æ ‡é¢˜è¡Œ -->
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-800">{{ room_id }}å·æˆ¿é—´</h2>
                <button id="exitBtn" class="ios-btn ios-btn-secondary">é€€æˆ¿</button>
            </div>
            
            <!-- è‡ªå®šä¹‰æ–‡æœ¬ç¼–è¾‘å™¨ -->
            <div class="mb-2 flex-1 flex">
                <textarea id="customEditor" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none flex-1" placeholder="è¾“å…¥å†…å®¹..."></textarea>
            </div>
            
            <!-- æ“ä½œæŒ‰é’®è¡Œ -->
            <div class="flex justify-between gap-3">
                <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–çš„æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
                <div class="upload-button-wrapper">
                    <button type="button" id="uploadTrigger" class="ios-btn ios-btn-secondary">
                        <span>ğŸ“æ–‡ä»¶ä¸Šä¼ </span>
                    </button>
                    <input type="file" id="fileInput" multiple class="absolute inset-0 opacity-0 cursor-pointer">
                    <input type="file" id="folderInput" multiple webkitdirectory directory class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <div class="flex gap-3">
                    <button id="clearBtn" class="ios-btn ios-btn-secondary">æ¸…é™¤</button>
                    <button id="sendBtn" class="ios-btn ios-btn-primary">å‘é€</button>
                </div>
            </div>
        </div>
        
        <!-- ç©ºç™½é—´éš”å®¹å™¨ï¼Œä¸å†å²è®°å½•å¡ç‰‡é—´çš„é«˜åº¦ä¸€è‡´ -->
        <div class="h-0.75"></div>
        
        <!-- è‡ªå®šä¹‰ä¸Šä¼ ç±»å‹é€‰æ‹©å¯¹è¯æ¡† -->
        <div id="uploadTypeDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">è¯·é€‰æ‹©æ‚¨è¦ä¸Šä¼ çš„ç±»å‹ï¼š</h3>
                <!-- <p class="text-gray-600 mb-6">è¯·é€‰æ‹©æ‚¨è¦ä¸Šä¼ çš„ç±»å‹ï¼š</p>  -->
                <div class="flex justify-end gap-3">
                    <button id="cancelUploadBtn" class="ios-btn ios-btn-secondary">å–  æ¶ˆ</button>
                    <button id="folderUploadBtn" class="ios-btn ios-btn-primary">æ–‡ä»¶å¤¹</button>
                    <button id="fileUploadBtn" class="ios-btn ios-btn-success">æ–‡  ä»¶</button>
                </div>
            </div>
        </div>
        
        <!-- å†å²è®°å½•å¡ç‰‡å®¹å™¨ -->
        <div id="historyContainer"></div>
    </div>
    
    <script>
        // æˆ¿é—´å·å’Œé™æ€è·¯å¾„å‰ç¼€
        const roomId = {{ room_id }};
        const staticPrefix = '{{ static_prefix }}';
        const uploadsPrefix = '{{ uploads_prefix }}';
        
        // å…¨å±€å˜é‡ï¼Œå­˜å‚¨é…ç½®ä¿¡æ¯
        let configInfo = {
            max_file_size_mb: 50,  // é»˜è®¤50MB
            max_file_size_bytes: 50 * 1024 * 1024
        };
        
        // WebSocketè¿æ¥å®ä¾‹
        let ws = null;
        
        // è·å–é…ç½®ä¿¡æ¯
        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const data = await response.json();
                    configInfo = data;
                    console.log('é…ç½®ä¿¡æ¯è·å–æˆåŠŸ:', configInfo);
                }
            } catch (error) {
                console.error('è·å–é…ç½®ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // ä¸ºç¼–è¾‘å™¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function setupEditorEventListeners() {
            // è·å–textareaå…ƒç´ 
            const editor = document.getElementById('customEditor');
            if (!editor) {
                console.error('ç¼–è¾‘å™¨å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            console.log('è®¾ç½®ç¼–è¾‘å™¨äº‹ä»¶ç›‘å¬å™¨');
            
            // ç›´æ¥ä¸ºtextareaæ·»åŠ contextmenuäº‹ä»¶å¤„ç†
            editor.addEventListener('contextmenu', async function(e) {
                console.log('contextmenuäº‹ä»¶è§¦å‘');
                
                try {
                    // å…ˆèšç„¦ç¼–è¾‘å™¨
                    editor.focus();
                    console.log('ç¼–è¾‘å™¨å·²èšç„¦');
                    
                    // å°è¯•ä½¿ç”¨æœ€ç›´æ¥çš„æ–¹æ³•è·å–å‰ªè´´æ¿å†…å®¹
                    let clipboardText;
                    let pasteSuccessful = false;
                    
                    // é¦–å…ˆå°è¯•ä½¿ç”¨Clipboard API
                    if (navigator.clipboard && navigator.clipboard.readText) {
                        try {
                            console.log('å°è¯•ä½¿ç”¨Clipboard APIè¯»å–å‰ªè´´æ¿');
                            clipboardText = await navigator.clipboard.readText();
                            console.log('ä½¿ç”¨Clipboard APIæˆåŠŸè·å–å‰ªè´´æ¿å†…å®¹:', clipboardText);
                            pasteSuccessful = true;
                        } catch (error) {
                            console.error('ä½¿ç”¨Clipboard APIè¯»å–å‰ªè´´æ¿å¤±è´¥:', error);
                            clipboardText = null;
                        }
                    } 
                    
                    // å¦‚æœClipboard APIå¤±è´¥æˆ–ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨document.execCommand
                    if (!clipboardText) {
                        console.log('å°è¯•ä½¿ç”¨document.execCommandè·å–å‰ªè´´æ¿å†…å®¹');
                        try {
                            // ç›´æ¥ä½¿ç”¨document.execCommand('paste')æ’å…¥å†…å®¹
                            // è¿™ä¼šè‡ªåŠ¨å¤„ç†æµè§ˆå™¨çš„å‰ªè´´æ¿è®¿é—®æƒé™
                            const result = document.execCommand('paste');
                            console.log('document.execCommand(paste)ç»“æœ:', result);
                            pasteSuccessful = result;
                        } catch (error) {
                            console.error('ä½¿ç”¨document.execCommandè¯»å–å‰ªè´´æ¿å¤±è´¥:', error);
                        }
                    } else if (clipboardText && clipboardText.trim()) {
                        console.log('æœ€ç»ˆè·å–åˆ°çš„å‰ªè´´æ¿å†…å®¹:', clipboardText);
                        
                        // å¤„ç†æ–‡æœ¬æ’å…¥åˆ°textareaä¸­
                        try {
                            // è·å–å½“å‰é€‰æ‹©èŒƒå›´
                            const startPos = editor.selectionStart;
                            const endPos = editor.selectionEnd;
                            console.log('å½“å‰é€‰æ‹©èŒƒå›´:', startPos, endPos);
                            
                            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                            const scrollTop = editor.scrollTop;
                            
                            // æ›¿æ¢é€‰ä¸­å†…å®¹æˆ–åœ¨å…‰æ ‡ä½ç½®æ’å…¥
                            const textBefore = editor.value.substring(0, startPos);
                            const textAfter = editor.value.substring(endPos);
                            editor.value = textBefore + clipboardText + textAfter;
                            
                            // æ¢å¤æ»šåŠ¨ä½ç½®
                            editor.scrollTop = scrollTop;
                            
                            // è®¾ç½®æ–°çš„å…‰æ ‡ä½ç½®
                            const newCursorPos = startPos + clipboardText.length;
                            editor.setSelection(newCursorPos, newCursorPos);
                            console.log('å…‰æ ‡å·²ç§»åŠ¨åˆ°æ’å…¥å†…å®¹æœ«å°¾:', newCursorPos);
                            pasteSuccessful = true;
                        } catch (error) {
                            console.error('æ’å…¥å†…å®¹å¤±è´¥:', error);
                        }
                    }
                    
                    if (pasteSuccessful) {
                        // åªåœ¨æˆåŠŸç²˜è´´åé˜»æ­¢é»˜è®¤èœå•
                        e.preventDefault();
                        console.log('å³é”®ç²˜è´´æˆåŠŸ');
                    } else {
                        console.log('å³é”®ç²˜è´´å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤èœå•');
                        // å…è®¸é»˜è®¤å³é”®èœå•æ˜¾ç¤º
                    }
                } catch (error) {
                    console.error('å³é”®ç²˜è´´åŠŸèƒ½æ‰§è¡Œå¤±è´¥:', error);
                    // å…è®¸é»˜è®¤å³é”®èœå•æ˜¾ç¤º
                }
            });
            
            // ä¸ºç¼–è¾‘å™¨æ·»åŠ é•¿æŒ‰ç²˜è´´åŠŸèƒ½ï¼ˆç§»åŠ¨ç«¯ï¼‰
            let longPressTimer;
            editor.addEventListener('touchstart', () => {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(longPressTimer);
                // è®¾ç½®é•¿æŒ‰å®šæ—¶å™¨ï¼Œ1ç§’åè§¦å‘ç²˜è´´
                longPressTimer = setTimeout(async () => {
                    try {
                        // å…ˆèšç„¦ç¼–è¾‘å™¨
                        editor.focus();
                        
                        // å°è¯•ä½¿ç”¨Clipboard APIè·å–å‰ªè´´æ¿å†…å®¹
                        let clipboardText;
                        
                        // é¦–å…ˆå°è¯•ä½¿ç”¨Clipboard API
                        if (navigator.clipboard && navigator.clipboard.readText) {
                            try {
                                clipboardText = await navigator.clipboard.readText();
                            } catch (error) {
                                console.error('ä½¿ç”¨Clipboard APIè¯»å–å‰ªè´´æ¿å¤±è´¥:', error);
                                clipboardText = null;
                            }
                        } 
                        
                        // å¦‚æœæˆåŠŸè·å–åˆ°å‰ªè´´æ¿å†…å®¹ï¼Œå°±ç²˜è´´åˆ°ç¼–è¾‘å™¨
                        if (clipboardText && clipboardText.trim()) {
                            // è·å–å½“å‰é€‰æ‹©èŒƒå›´
                            const startPos = editor.selectionStart;
                            const endPos = editor.selectionEnd;
                            
                            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                            const scrollTop = editor.scrollTop;
                            
                            // æ›¿æ¢é€‰ä¸­å†…å®¹æˆ–åœ¨å…‰æ ‡ä½ç½®æ’å…¥
                            const textBefore = editor.value.substring(0, startPos);
                            const textAfter = editor.value.substring(endPos);
                            editor.value = textBefore + clipboardText + textAfter;
                            
                            // æ¢å¤æ»šåŠ¨ä½ç½®
                            editor.scrollTop = scrollTop;
                            
                            // è®¾ç½®æ–°çš„å…‰æ ‡ä½ç½®
                            const newCursorPos = startPos + clipboardText.length;
                            editor.setSelection(newCursorPos, newCursorPos);
                        }
                    } catch (error) {
                        console.error('é•¿æŒ‰ç²˜è´´å¤±è´¥:', error);
                    }
                }, 1000);
            });
            
            // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
            editor.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
            });
            
            editor.addEventListener('touchmove', () => {
                clearTimeout(longPressTimer);
            });
            
            console.log('å³é”®äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }
        
        // å…¨å±€å˜é‡ï¼Œæ§åˆ¶æ˜¯å¦å¯ç”¨åˆ é™¤åŠŸèƒ½
        let enableRecordDeletion = true;
        
        // è·å–å†å²è®°å½•
        async function fetchHistory() {
            console.log('fetchHistory called with roomId:', roomId);
            try {
                console.log('Fetching from URL:', `/api/records/${roomId}`);
                const response = await fetch(`/api/records/${roomId}`);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                if (data.status === 'success') {
                    console.log('Rendering', data.records.length, 'records');
                    // è·å–æ˜¯å¦å¯ç”¨åˆ é™¤åŠŸèƒ½çš„é…ç½®
                    enableRecordDeletion = data.enable_record_deletion !== undefined ? data.enable_record_deletion : true;
                    renderHistory(data.records);
                } else {
                    console.error('API returned error:', data);
                }
            } catch (error) {
                console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory(records) {
            console.log('renderHistory called with', records.length, 'records');
            const container = document.getElementById('historyContainer');
            console.log('Container found:', !!container);
            container.innerHTML = '';
            
            records.forEach(record => {
                const card = createHistoryCard(record);
                container.appendChild(card);
            });
            console.log('Finished rendering records');
        }
        
        // HTMLè½¬çº¯æ–‡æœ¬å‡½æ•°
        function htmlToPlainText(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }
        
        // æ ¹æ®ç”¨æˆ·IDè·å–å¯¹åº”çš„å“ºä¹³åŠ¨ç‰©emoji
        function getMammalEmoji(clientId) {
            // å“ºä¹³åŠ¨ç‰©emojiåˆ—è¡¨
            const mammals = [
                'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ…', 'ğŸ†', 'ğŸ‡', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ', 'ğŸ',
                'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ•', 'ğŸ•â€ğŸ¦º', 'ğŸ–', 'ğŸ—', 'ğŸ˜', 'ğŸ¨', 'ğŸ©',
                'ğŸª', 'ğŸ«', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ°', 'ğŸ±', 'ğŸ´', 'ğŸµ', 'ğŸ¶',
                'ğŸ·', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ»â€â„ï¸', 'ğŸ¼', 'ğŸ½', 'ğŸ¾', 'ğŸ¿ï¸', 'ğŸ¦',
                'ğŸ¦„', 'ğŸ¦‡', 'ğŸ¦Š', 'ğŸ¦Œ', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦’', 'ğŸ¦“', 'ğŸ¦”', 'ğŸ¦˜',
                'ğŸ¦™', 'ğŸ¦›', 'ğŸ¦', 'ğŸ¦¡', 'ğŸ¦£', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦§', 'ğŸ¦¨', 'ğŸ¦«',
                'ğŸ¦¬', 'ğŸ¦®', 'ğŸ«', 'ğŸ«'
            ];
            
            // å¦‚æœæ˜¯åŒ¿åç”¨æˆ·ï¼Œè¿”å›ä¸€ä¸ªé»˜è®¤emoji
            if (clientId === 'åŒ¿å' || !clientId) {
                return 'ğŸ‘¤';
            }
            
            // è®¡ç®—ç”¨æˆ·IDçš„å“ˆå¸Œå€¼
            let hash = 0;
            for (let i = 0; i < clientId.length; i++) {
                const char = clientId.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
            }
            
            // ä½¿ç”¨å“ˆå¸Œå€¼é€‰æ‹©emoji
            const index = Math.abs(hash) % mammals.length;
            return mammals[index];
        }
        
        // åˆ›å»ºå†å²è®°å½•å¡ç‰‡
        function createHistoryCard(record) {
            const card = document.createElement('div');
            card.className = 'history-card';
            card.dataset.id = record.id;
            
            let contentHtml = '';
            if (record.type === 'text') {
                // åªæ˜¾ç¤ºç´¢å¼•å·çš„ç¬¬7-23ä½æ•°å­—
                const displayIndex = record.record_index.substring(6, 23);
                // åªæ˜¾ç¤ºç”¨æˆ·IDçš„æœ€å12ä½å†…å®¹ï¼Œå¹¶å°†æœ€å2ä½åŠ ç²—
                const fullClientId = record.client_id ? record.client_id.slice(-12) : 'N/A';
                let displayClientId;
                if (fullClientId.length > 2) {
                    const mainPart = fullClientId.slice(0, -2);
                    const boldPart = fullClientId.slice(-2);
                    displayClientId = `${mainPart}<strong>${boldPart}</strong>`;
                } else {
                    displayClientId = `<strong>${fullClientId}</strong>`;
                }
                const emoji = getMammalEmoji(record.client_id);
                contentHtml = `
                    <div class="text-xs text-gray-400 mb-1">#${displayIndex} | ç”¨æˆ·ID: ${displayClientId} ${emoji}</div>
                    <div class="text-sm text-gray-800 whitespace-pre-line" style="max-height: calc(1rem * 1.5 * 4); overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none;">${record.content}<style> .history-card div[style*="overflow-y: auto"]::-webkit-scrollbar { display: none; }</style></div>
                `;
            } else {
                // æ–‡ä»¶ç±»å‹ - é¦–å…ˆå°è¯•ä»é…ç½®çš„æ–‡ä»¶æ ¼å¼å›¾æ ‡åº“ç›®å½•è·å–å›¾æ ‡
                // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶æ ¼å¼å›¾æ ‡åº“è·¯å¾„
                const iconUrl = `/file_icons/${record.file_extension || 'files'}.png`;
                // åªæ˜¾ç¤ºç´¢å¼•å·çš„ç¬¬7-23ä½æ•°å­—
                const displayIndex = record.record_index.substring(6, 23);
                // åªæ˜¾ç¤ºç”¨æˆ·IDçš„æœ€å12ä½å†…å®¹ï¼Œå¹¶å°†æœ€å2ä½åŠ ç²—
                const fullClientId = record.client_id ? record.client_id.slice(-12) : 'N/A';
                let displayClientId;
                if (fullClientId.length > 2) {
                    const mainPart = fullClientId.slice(0, -2);
                    const boldPart = fullClientId.slice(-2);
                    displayClientId = `${mainPart}<strong>${boldPart}</strong>`;
                } else {
                    displayClientId = `<strong>${fullClientId}</strong>`;
                }
                const emoji = getMammalEmoji(record.client_id);
                contentHtml = `
                    <div class="text-xs text-gray-400 mb-1">#${displayIndex} | ç”¨æˆ·ID: ${displayClientId} ${emoji}</div>
                    <div class="flex items-center gap-3">
                        <div class="file-icon">
                            <img src="${iconUrl}" alt="File Icon" onerror="this.onerror=null; this.src='/file_icons/${record.file_extension || 'files'}.png'; this.onerror=null; this.src='/file_icons/files.png'"></div>
                            <div style="flex: 1;">
                            <div class="text-sm font-medium text-gray-800 break-words">${record.original_filename}</div>
                            <div class="text-xs text-gray-500">${formatFileSize(record.file_size)}</div>
                        </div>
                    </div>
                `;
            }
            
            // æ ¹æ®é…ç½®å†³å®šæ˜¯å¦æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            const deleteButtonHtml = enableRecordDeletion ? `
                <button class="delete-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            ` : '';
            
            card.innerHTML = `
                ${contentHtml}
                ${deleteButtonHtml}
                <div class="mask-overlay">
                    <div class="text">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>
                </div>
            `;
            
            // é˜²æŠ–åŠ¨å˜é‡
            let lastCopyTime = 0;
            const DEBOUNCE_THRESHOLD = 500; // 500mså†…åªå…è®¸ä¸€æ¬¡å¤åˆ¶/ä¸‹è½½
            
            // é€šç”¨çš„å¤åˆ¶å¤„ç†å‡½æ•°
            const handleCopy = () => {
                // é˜²æŠ–åŠ¨å¤„ç†
                const now = Date.now();
                if (now - lastCopyTime < DEBOUNCE_THRESHOLD) {
                    return;
                }
                lastCopyTime = now;
                
                if (record.type === 'text') {
                    // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
                    const plainText = htmlToPlainText(record.content);
                    
                    // å°è¯•ä½¿ç”¨Clipboard API
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(plainText).then(() => {
                            // æ˜¾ç¤ºé®ç½©åé¦ˆ
                            const mask = card.querySelector('.mask-overlay');
                            mask.classList.add('active');
                            setTimeout(() => {
                                mask.classList.remove('active');
                            }, 1500); // 1.5ç§’åéšè—
                        }).catch(err => {
                            console.error('ä½¿ç”¨Clipboard APIå¤åˆ¶å¤±è´¥:', err);
                            // å°è¯•é™çº§æ–¹æ¡ˆ
                            fallbackCopyTextToClipboard(plainText, card);
                        });
                    } else {
                        // é™çº§æ–¹æ¡ˆ
                        fallbackCopyTextToClipboard(plainText, card);
                    }
                } else {
                    // ä¸‹è½½æ–‡ä»¶
                    const link = document.createElement('a');
                    link.href = `/api/download/${record.id}`;
                    link.download = record.original_filename; // è®¾ç½®ä¸‹è½½çš„æ–‡ä»¶å
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };
            
            // ç®€åŒ–çš„å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆå¤åˆ¶æˆ–ä¸‹è½½ï¼‰
            card.addEventListener('click', (e) => {
                // æ’é™¤ç‚¹å‡»åˆ é™¤æŒ‰é’®çš„æƒ…å†µ
                if (e.target.closest('.delete-btn')) return;
                
                handleCopy();
            });
            
            // ç§»é™¤æ‰€æœ‰è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…ä¸æ»šåŠ¨å†²çª
            // ç°ä»£æµè§ˆå™¨ä¼šè‡ªåŠ¨å°†è§¦æ‘¸è½¬æ¢ä¸ºç‚¹å‡»äº‹ä»¶ï¼Œæ— éœ€é¢å¤–å¤„ç†
            
            // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä»…å½“å¯ç”¨åˆ é™¤åŠŸèƒ½æ—¶æ·»åŠ ï¼‰
            if (enableRecordDeletion) {
                card.querySelector('.delete-btn').addEventListener('click', (e) => {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                    e.stopPropagation();
                    deleteRecord(record.id);
                });
            }
            
            return card;
        }
        
        // é™çº§å¤åˆ¶æ–¹æ¡ˆï¼Œç”¨äºä¸æ”¯æŒClipboard APIçš„æµè§ˆå™¨
        function fallbackCopyTextToClipboard(text, cardElement) {
            // åˆ›å»ºä¸´æ—¶textareaå…ƒç´ 
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // ç¡®ä¿å…ƒç´ ä¸å¯è§ï¼Œä½†èƒ½è¢«é€‰ä¸­
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            
            // é€‰ä¸­å¹¶å¤åˆ¶
            textArea.focus();
            textArea.select();
            
            try {
                // æ‰§è¡Œå¤åˆ¶å‘½ä»¤
                const successful = document.execCommand('copy');
                if (successful) {
                    // æ˜¾ç¤ºé®ç½©åé¦ˆ
                    const mask = cardElement.querySelector('.mask-overlay');
                    mask.classList.add('active');
                    setTimeout(() => {
                        mask.classList.remove('active');
                    }, 1500); // 1.5ç§’åéšè—
                } else {
                    console.error('ä½¿ç”¨execCommandå¤åˆ¶å¤±è´¥');
                }
            } catch (err) {
                console.error('ä½¿ç”¨execCommandå¤åˆ¶å¤±è´¥:', err);
            }
            
            // æ¸…ç†ä¸´æ—¶å…ƒç´ 
            document.body.removeChild(textArea);
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(sizeInBytes) {
            if (sizeInBytes < 1024) {
                return `${sizeInBytes} B`;
            } else if (sizeInBytes < 1024 * 1024) {
                return `${(sizeInBytes / 1024).toFixed(2)} KB`;
            } else {
                return `${(sizeInBytes / (1024 * 1024)).toFixed(2)} MB`;
            }
        }
        
        // è·å–æˆ–ç”Ÿæˆclient_id
        function getClientId() {
            let clientId = localStorage.getItem('client_id');
            if (!clientId) {
                // ç”Ÿæˆä¸€ä¸ªUUIDï¼Œå…¼å®¹ä¸æ”¯æŒcrypto.randomUUID()çš„æµè§ˆå™¨
                if (crypto && crypto.randomUUID) {
                    clientId = crypto.randomUUID();
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç”ŸæˆUUID
                    clientId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
                localStorage.setItem('client_id', clientId);
            }
            return clientId;
        }

        async function sendText() {
            // è·å–è‡ªå®šä¹‰ç¼–è¾‘å™¨çš„å†…å®¹
            const editor = document.getElementById('customEditor');
            const content = editor.value;
            if (!content.trim()) {
                return;
            }
            
            try {
                const response = await fetch('/api/send_text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ room_id: roomId, content: content, client_id: getClientId() })
                });
                
                if (response.ok) {
                    // æ¸…ç©ºç¼–è¾‘å™¨
                    editor.value = '';
                    // åˆ·æ–°å†å²è®°å½•
                    fetchHistory();
                    
                    // å‘é€WebSocketæ¶ˆæ¯é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        // è§£æå“åº”æ•°æ®ï¼Œè·å–æ–°åˆ›å»ºçš„è®°å½•
                        const data = await response.json();
                        if (data.status === 'success') {
                            ws.send(JSON.stringify({
                                type: 'text_update',
                                record: data.record
                            }));
                        }
                    } else {
                        console.warn('WebSocketè¿æ¥ä¸å¯ç”¨ï¼Œæ— æ³•é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯');
                    }
                }
            } catch (error) {
                console.error('å‘é€æ–‡æœ¬å¤±è´¥:', error);
            }
        }
        
        // æ–‡ä»¶å¤¹å‹ç¼©å‡½æ•°
        async function zipFolder(files) {
            const zip = new JSZip();
            let folderName = null;
            let processedFiles = 0;
            const totalFiles = files.length;
            
            // å¤„ç†æ–‡ä»¶åˆ—è¡¨
            for (const file of files) {
                if (!folderName && file.webkitRelativePath) {
                    // è·å–æ–‡ä»¶å¤¹åç§°
                    folderName = file.webkitRelativePath.split('/')[0];
                }
                
                // å°†æ–‡ä»¶æ·»åŠ åˆ°ZIPä¸­
                zip.file(file.webkitRelativePath || file.name, file);
                
                // æ›´æ–°è¿›åº¦
                processedFiles++;
                const progress = Math.round((processedFiles / totalFiles) * 100);
                showFeedback(`æ­£åœ¨å‹ç¼©æ–‡ä»¶å¤¹: ${progress}%`);
            }
            
            // ç”ŸæˆZIPæ–‡ä»¶
            showFeedback('æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...');
            const zipBlob = await zip.generateAsync({ 
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });
            
            return {
                zipBlob,
                folderName: folderName || 'folder'
            };
        }
        
        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        async function uploadSingleFile(file) {
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > configInfo.max_file_size_bytes) {
                showFeedback(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§${configInfo.max_file_size_mb}MBï¼‰`);
                return false;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('room_id', roomId);
            formData.append('client_id', getClientId());
            
            try {
                // æ˜¾ç¤ºä¸Šä¼ ä¸­åé¦ˆï¼ŒåŒ…å«æ–‡ä»¶å
                showFeedback(`æ­£åœ¨ä¸Šä¼ : ${file.name}`);
                
                // å‘é€fetchè¯·æ±‚åˆ°åç«¯APIï¼Œæ·»åŠ é€‚å½“çš„headers
                const response = await fetch('/api/upload_file', {
                    method: 'POST',
                    // ä¸è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å¤„ç†
                    headers: {
                        // æ·»åŠ X-Requested-Withå¤´ï¼Œæ ‡è¯†ä¸ºAJAXè¯·æ±‚
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error('æœåŠ¡å™¨å“åº”å¤±è´¥: ' + response.status);
                }
                
                // è§£æå“åº”æ•°æ®
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`);
                    
                    // å‘é€WebSocketæ¶ˆæ¯é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'file_upload',
                            record: data.record
                        }));
                    } else {
                        console.warn('WebSocketè¿æ¥ä¸å¯ç”¨ï¼Œæ— æ³•é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯');
                    }
                    
                    return true;
                } else {
                    console.error(`ä¸Šä¼ å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                    return false;
                }
            } catch (error) {
                console.error(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥:`, error);
                return false;
            }
        }
        
        // ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
        async function uploadFile(files) {
            if (files.length === 0) {
                console.warn('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶æ€»æ•°
            showFeedback(`å‡†å¤‡ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`);
            
            let successCount = 0;
            let failCount = 0;
            
            // é€ä¸ªä¸Šä¼ æ–‡ä»¶
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const result = await uploadSingleFile(file);
                
                if (result) {
                    successCount++;
                } else {
                    failCount++;
                }
            }
            
            // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
            let finalMessage = '';
            if (failCount === 0) {
                finalMessage = `${successCount} ä¸ªæ–‡ä»¶å…¨éƒ¨ä¸Šä¼ å®Œæˆ`;
            } else {
                finalMessage = `ä¸Šä¼ ç»“æœ: æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`;
            }
            
            showFeedback(finalMessage);
            
            // æ— è®ºæˆåŠŸå¤±è´¥éƒ½åˆ·æ–°å†å²è®°å½•ï¼Œç¡®ä¿å·²ä¸Šä¼ çš„æ–‡ä»¶æ˜¾ç¤ºå‡ºæ¥
            fetchHistory();
        }
        
        // æ˜¾ç¤ºé®ç½©åé¦ˆå‡½æ•°
        function showFeedback(message) {
            const uploadWrapper = document.querySelector('.upload-button-wrapper');
            if (!uploadWrapper) return;
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºé®ç½©å±‚
            let mask = uploadWrapper.querySelector('.mask-overlay');
            if (!mask) {
                mask = document.createElement('div');
                mask.className = 'mask-overlay';
                const text = document.createElement('div');
                text.className = 'text';
                mask.appendChild(text);
                uploadWrapper.appendChild(mask);
            }
            
            // æ›´æ–°æ¶ˆæ¯æ–‡æœ¬
            const text = mask.querySelector('.text');
            if (text) {
                text.textContent = message;
            }
            
            // æ˜¾ç¤ºé®ç½©
            mask.classList.add('active');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            clearTimeout(mask.timeoutId);
            
            // åªæœ‰é'ä¸Šä¼ ä¸­'æ¶ˆæ¯æ‰ä¼šè‡ªåŠ¨éšè—
            // 'ä¸Šä¼ ä¸­'æ¶ˆæ¯å°†ä¿æŒæ˜¾ç¤ºç›´åˆ°ä¸Šä¼ å®Œæˆï¼Œç”±åç»­çš„'success'æˆ–'error'çŠ¶æ€è¦†ç›–
            if (message !== 'ä¸Šä¼ ä¸­') {
                mask.timeoutId = setTimeout(() => {
                    mask.classList.remove('active');
                }, 1500);
            }
            // è®°å½•å½“å‰æ¶ˆæ¯çŠ¶æ€
            mask.currentMessage = message;
        }
        
        // åˆ é™¤è®°å½•
        async function deleteRecord(recordId) {
            console.log(`å¼€å§‹åˆ é™¤è®°å½•ï¼ŒID: ${recordId}`);
            try {
                console.log(`å‘é€åˆ é™¤è¯·æ±‚åˆ°æœåŠ¡å™¨: /api/delete_record/${recordId}`);
                const response = await fetch(`/api/delete_record/${recordId}`, {
                    method: 'DELETE'
                });
                
                console.log(`åˆ é™¤è¯·æ±‚å“åº”çŠ¶æ€: ${response.status}`);
                const data = await response.json();
                console.log(`åˆ é™¤è¯·æ±‚å“åº”æ•°æ®:`, data);
                
                if (data.status === 'success') {
                    console.log(`åˆ é™¤è¯·æ±‚æˆåŠŸï¼Œè®°å½•ID: ${recordId}`);
                    // å‘é€WebSocketæ¶ˆæ¯
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        console.log(`WebSocketè¿æ¥å¯ç”¨ï¼Œå‡†å¤‡å‘é€åˆ é™¤æ¶ˆæ¯`);
                        const wsMessage = JSON.stringify({
                            type: 'record_delete',
                            record_id: recordId
                        });
                        console.log(`å‘é€WebSocketæ¶ˆæ¯: ${wsMessage}`);
                        ws.send(wsMessage);
                        console.log(`WebSocketæ¶ˆæ¯å‘é€å®Œæˆ`);
                    } else {
                        console.warn('WebSocketè¿æ¥ä¸å¯ç”¨ï¼Œæ— æ³•é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯åˆ é™¤æ“ä½œ');
                    }
                    
                    // ç«‹å³åˆ·æ–°å½“å‰é¡µé¢çš„å†å²è®°å½•ï¼Œç¡®ä¿åˆ é™¤ç«¯ä¹Ÿèƒ½çœ‹åˆ°æ›´æ–°
                    console.log('ç«‹å³åˆ·æ–°å½“å‰é¡µé¢çš„å†å²è®°å½•');
                    fetchHistory();
                }
            } catch (error) {
                console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
            }
        }
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢åˆ‡å›å‰å°æ—¶ä¸»åŠ¨åŒæ­¥æ•°æ®
        function setupVisibilityListener() {
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('é¡µé¢åˆ‡å›å‰å°ï¼Œæ­£åœ¨åŒæ­¥æœ€æ–°æ•°æ®...');
                    // ç«‹å³é‡æ–°è·å–å†å²è®°å½•ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
                    fetchHistory();
                    
                    // æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€ï¼Œå¦‚æœå·²å…³é—­åˆ™é‡æ–°è¿æ¥
                    if (ws && (ws.readyState === WebSocket.CLOSED || ws.readyState === WebSocket.CLOSING)) {
                        console.log('WebSocketè¿æ¥å·²å…³é—­ï¼Œé‡æ–°è¿æ¥...');
                        initWebSocket();
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            // ç›´æ¥ä½¿ç”¨textareaå…ƒç´ ï¼Œæ— éœ€åˆå§‹åŒ–Quillç¼–è¾‘å™¨
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œä½¿ç”¨textareaç¼–è¾‘å™¨');
            
            // è·å–é…ç½®ä¿¡æ¯
            fetchConfig();
            
            // è®¾ç½®ç¼–è¾‘å™¨äº‹ä»¶ç›‘å¬å™¨
            setupEditorEventListeners();
            
            // è®¾ç½®é¡µé¢å¯è§æ€§ç›‘å¬å™¨
            setupVisibilityListener();
            
            // åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆæ”¯æŒè‡ªåŠ¨é‡è¿ï¼‰
            function initWebSocket() {
                // å¦‚æœå·²å­˜åœ¨WebSocketè¿æ¥ï¼Œå…ˆå…³é—­
                if (ws && ws.readyState !== WebSocket.CLOSED) {
                    ws.close();
                }
                
                // æ ¹æ®å½“å‰åè®®é€‰æ‹©wsæˆ–wss
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                // ç¡®ä¿æˆ¿é—´å·æ ¼å¼ä¸º6ä½æ•°å­—
                const formattedRoomId = roomId.toString().padStart(6, '0');
                ws = new WebSocket(`${protocol}//${window.location.host}/ws/${formattedRoomId}`);
                
                ws.onopen = () => {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    // å‘é€client_idå’Œroom_idåˆ°æœåŠ¡å™¨
                    ws.send(JSON.stringify({
                        type: 'register_client',
                        client_id: getClientId(),
                        room_id: roomId
                    }));
                };
                
                ws.onmessage = (event) => {
                    console.log('WebSocketæ”¶åˆ°æ¶ˆæ¯:', event.data);
                    const data = JSON.parse(event.data);
                    console.log('è§£æåçš„WebSocketæ¶ˆæ¯:', data);
                    // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
                    if (data.type === 'session_timeout') {
                        // ä¼šè¯è¶…æ—¶ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                        alert(data.message || 'ä¼šè¯å·²è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•');
                        window.location.href = '/login';
                    } else if (data.type === 'text_update' || data.type === 'file_upload') {
                        console.log('æ”¶åˆ°æ›´æ–°ç±»å‹æ¶ˆæ¯ï¼Œåˆ·æ–°å†å²è®°å½•');
                        // åˆ·æ–°å†å²è®°å½•
                        fetchHistory();
                    } else if (data.type === 'record_delete') {
                        console.log(`æ”¶åˆ°åˆ é™¤è®°å½•æ¶ˆæ¯ï¼Œè®°å½•ID: ${data.record_id}ï¼Œæ­£åœ¨åˆ·æ–°å†å²è®°å½•`);
                        // åˆ·æ–°å†å²è®°å½•
                        fetchHistory();
                    } else {
                        console.log('æ”¶åˆ°æœªå¤„ç†ç±»å‹çš„æ¶ˆæ¯:', data.type);
                    }
                };
                
                ws.onclose = () => {
                    console.log('WebSocketè¿æ¥å·²å…³é—­ï¼Œå°†åœ¨5ç§’åå°è¯•é‡è¿');
                    setTimeout(initWebSocket, 5000);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                };
            }
            initWebSocket();
            
            // ç›´æ¥ç»‘å®šæ‰€æœ‰æŒ‰é’®äº‹ä»¶ï¼Œä¸ä½¿ç”¨å¤æ‚å°è£…
            const sendBtn = document.getElementById('sendBtn');
            const clearBtn = document.getElementById('clearBtn');
            const exitBtn = document.getElementById('exitBtn');
            const uploadTrigger = document.getElementById('uploadTrigger');
            const fileInput = document.getElementById('fileInput');
            const folderInput = document.getElementById('folderInput');
            
            // å‘é€æ–‡æœ¬
            sendBtn.onclick = sendText;
            
            // æ¸…é™¤ç¼–è¾‘å™¨
            clearBtn.onclick = () => {
                const editor = document.getElementById('customEditor');
                if (editor) {
                    editor.value = '';
                }
            };
            
            // é€€å‡ºæˆ¿é—´
            exitBtn.onclick = () => {
                window.location.href = '/login';
            };
            
            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadTrigger.onclick = () => {
                // æ˜¾ç¤ºè‡ªå®šä¹‰ä¸Šä¼ ç±»å‹é€‰æ‹©å¯¹è¯æ¡†
                document.getElementById('uploadTypeDialog').classList.remove('hidden');
            };
            
            // è‡ªå®šä¹‰å¯¹è¯æ¡†æŒ‰é’®äº‹ä»¶
            document.getElementById('cancelUploadBtn').onclick = () => {
                // å…³é—­å¯¹è¯æ¡†
                document.getElementById('uploadTypeDialog').classList.add('hidden');
            };
            
            document.getElementById('fileUploadBtn').onclick = () => {
                // é€‰æ‹©æ–‡ä»¶
                fileInput.click();
                // å…³é—­å¯¹è¯æ¡†
                document.getElementById('uploadTypeDialog').classList.add('hidden');
            };
            
            document.getElementById('folderUploadBtn').onclick = () => {
                // é€‰æ‹©æ–‡ä»¶å¤¹
                folderInput.click();
                // å…³é—­å¯¹è¯æ¡†
                document.getElementById('uploadTypeDialog').classList.add('hidden');
            };
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
            fileInput.onchange = () => {
                if (fileInput.files.length > 0) {
                    // å¤åˆ¶FileListåˆ°æ•°ç»„ï¼Œå› ä¸ºFileListæ˜¯ç±»æ•°ç»„å¯¹è±¡ï¼Œä¸”åœ¨inputè¢«æ¸…ç©ºåä¼šä¸¢å¤±
                    const filesToUpload = Array.from(fileInput.files);
                    // å•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ä¸Šä¼ ï¼Œä¿æŒåŸæœ‰é€»è¾‘
                    uploadFile(filesToUpload);
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                    fileInput.value = '';
                }
            };
            
            // æ–‡ä»¶å¤¹é€‰æ‹©å˜åŒ–äº‹ä»¶
            folderInput.onchange = async () => {
                if (folderInput.files.length > 0) {
                    // å¤åˆ¶FileListåˆ°æ•°ç»„ï¼Œå› ä¸ºFileListæ˜¯ç±»æ•°ç»„å¯¹è±¡ï¼Œä¸”åœ¨inputè¢«æ¸…ç©ºåä¼šä¸¢å¤±
                    const filesToUpload = Array.from(folderInput.files);
                    
                    // è®¡ç®—æ–‡ä»¶å¤¹æ€»å¤§å°
                    let totalSize = 0;
                    for (const file of filesToUpload) {
                        totalSize += file.size;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤¹å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶
                    if (totalSize > configInfo.max_file_size_bytes) {
                        showFeedback(`æ–‡ä»¶å¤¹å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§${configInfo.max_file_size_mb}MBï¼‰`);
                        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                        folderInput.value = '';
                        return;
                    }
                    
                    // æ˜¾ç¤ºå‹ç¼©ä¸­æç¤º
                    showFeedback('æ­£åœ¨å‹ç¼©æ–‡ä»¶å¤¹...');
                    
                    try {
                        // å‹ç¼©æ–‡ä»¶å¤¹
                        const { zipBlob, folderName } = await zipFolder(filesToUpload);
                        
                        // åˆ›å»ºä¸€ä¸ªæ–°çš„Fileå¯¹è±¡
                        const zipFile = new File([zipBlob], `${folderName}.zip`, { type: 'application/zip' });
                        
                        // ä¸Šä¼ ZIPæ–‡ä»¶ï¼Œå¤ç”¨ç°æœ‰å‡½æ•°
                        await uploadFile([zipFile]);
                    } catch (error) {
                        console.error('æ–‡ä»¶å¤¹å‹ç¼©å¤±è´¥:', error);
                        showFeedback('æ–‡ä»¶å¤¹å‹ç¼©å¤±è´¥');
                    }
                    
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                    folderInput.value = '';
                }
            };
            
            // è·å–å†å²è®°å½•
            fetchHistory();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - 登录</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon.png" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 自定义样式 -->
    <style>
        /* iOS18 风格基础样式 */
        body {
            background-color: #f5f5f7;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* PIN码输入框样式 */
        .pin-input {
    width: 38px;
    height: 70px;
    border: none;
    border-radius: 14px;
    font-size: 32px;
    text-align: center;
    background-color: #ffffff;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}
        
        .pin-input:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2);
        }
        
        /* 数字键盘按钮样式 */
        .keyboard-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ffffff;
            border: none;
            font-size: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            -webkit-tap-highlight-color: transparent; /* 移除iOS默认的点击高亮 */
        }
        
        .keyboard-btn:hover {
            background-color: #f0f0f0;
        }
        
        .keyboard-btn:active {
            transform: scale(0.95);
            background-color: #e0e0e0; /* 按下时背景色变化更明显 */
        }
        
        .keyboard-btn.touch-active {
            background-color: #e0e0e0;
            transform: scale(0.95);
        }
        
        /* 删除按钮样式 */
        .delete-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ffffff;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            -webkit-tap-highlight-color: transparent; /* 移除iOS默认的点击高亮 */
        }
        
        .delete-btn:hover {
            background-color: #f0f0f0;
        }
        
        .delete-btn:active {
            transform: scale(0.95);
            background-color: #e0e0e0; /* 按下时背景色变化更明显 */
        }
        
        .delete-btn.touch-active {
            background-color: #e0e0e0;
            transform: scale(0.95);
        }
        
        /* 移动端设备上调整删除按钮图标 */
        @media (max-width: 768px) {
            #backspaceIcon {
                display: inline-block;
                transform: scale(1, 1);
            }
        }
        
        /* 限流提示样式 */
        .rate-limit-alert {
            background-color: #ff3b30;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .rate-limit-alert.show {
            opacity: 1;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 pt-16">
    <!-- 标题 -->
    <h1 class="text-3xl font-bold text-gray-800" style="margin-top: 0; margin-bottom: 0.5rem;">{{ project_name }}</h1>
    <!-- 匿名房间提示 -->
    {% if anonymous_rooms %}
    <p class="text-sm text-gray-500 mb-2" style="line-height: 0.7;">匿名房间：{{ anonymous_rooms[0] }}</p>
    {% endif %}
    
    <!-- 历史记录保存时间提醒 -->
    <p class="text-sm text-red-500 mb-2" style="line-height: 0.7;">提醒：除安全房间外，历史记录保存时间为 {{ history_retention_days }} 天</p>
    
    <!-- 限流提示 -->
    <div id="rateLimitAlert" class="rate-limit-alert">
        请求过于频繁，请稍后再试
    </div>
    
    <!-- PIN码输入区域 -->
    <div class="flex justify-center gap-4 mb-6" style="margin-top: -45px;">
        <input type="text" id="pin1" class="pin-input" maxlength="1" autocomplete="off" inputmode="numeric" readonly onselectstart="return false" onmousedown="return false" ontouchstart="return false">
        <input type="text" id="pin2" class="pin-input" maxlength="1" autocomplete="off" inputmode="numeric" readonly onselectstart="return false" onmousedown="return false" ontouchstart="return false">
        <input type="text" id="pin3" class="pin-input" maxlength="1" autocomplete="off" inputmode="numeric" readonly onselectstart="return false" onmousedown="return false" ontouchstart="return false">
        <input type="text" id="pin4" class="pin-input" maxlength="1" autocomplete="off" inputmode="numeric" readonly onselectstart="return false" onmousedown="return false" ontouchstart="return false">
        <input type="text" id="pin5" class="pin-input" maxlength="1" autocomplete="off" inputmode="numeric" readonly onselectstart="return false" onmousedown="return false" ontouchstart="return false">
        <input type="text" id="pin6" class="pin-input" maxlength="1" autocomplete="off" inputmode="numeric" readonly onselectstart="return false" onmousedown="return false" ontouchstart="return false">
    </div>
    
    <!-- 数字键盘 -->
    <div class="grid grid-cols-3 gap-6">
        <button class="keyboard-btn" data-key="1">1</button>
        <button class="keyboard-btn" data-key="2">2</button>
        <button class="keyboard-btn" data-key="3">3</button>
        <button class="keyboard-btn" data-key="4">4</button>
        <button class="keyboard-btn" data-key="5">5</button>
        <button class="keyboard-btn" data-key="6">6</button>
        <button class="keyboard-btn" data-key="7">7</button>
        <button class="keyboard-btn" data-key="8">8</button>
        <button class="keyboard-btn" data-key="9">9</button>
        <button class="keyboard-btn opacity-0"></button> <!-- 占位符 -->
        <button class="keyboard-btn" data-key="0">0</button>
        <button class="delete-btn" id="deleteBtn">
            <span id="backspaceIcon" style="font-size: 32px;">⇦</span>
        </button>
    </div>
    
    <script>
        // 获取DOM元素
        const pinInputs = [
            document.getElementById('pin1'),
            document.getElementById('pin2'),
            document.getElementById('pin3'),
            document.getElementById('pin4'),
            document.getElementById('pin5'),
            document.getElementById('pin6')
        ];
        const keyboardBtns = document.querySelectorAll('.keyboard-btn[data-key]');
        const deleteBtn = document.getElementById('deleteBtn');
        const rateLimitAlert = document.getElementById('rateLimitAlert');
        
        // 当前输入框索引
        let currentIndex = 0;
        
        // 自动聚焦第一个输入框
        pinInputs[currentIndex].focus();
        
        // 键盘按钮点击事件
        keyboardBtns.forEach(btn => {
            // 点击事件处理
            btn.addEventListener('click', () => {
                const key = btn.dataset.key;
                if (currentIndex < 6) {
                    pinInputs[currentIndex].value = key;
                    currentIndex++;
                    if (currentIndex < 6) {
                        pinInputs[currentIndex].focus();
                    } else {
                        // 输入完成，触发登录
                        handleLogin();
                    }
                }
            });
            
            // 添加触摸事件处理，解决移动端按钮状态问题
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault(); // 防止触发mouse事件
                btn.classList.add('touch-active');
            });
            
            btn.addEventListener('touchend', (e) => {
                e.preventDefault(); // 防止触发mouse事件
                btn.classList.remove('touch-active');
                // 手动触发点击事件
                btn.click();
            });
            
            btn.addEventListener('touchcancel', () => {
                btn.classList.remove('touch-active');
            });
        });
        
        // 删除按钮点击事件
        deleteBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                pinInputs[currentIndex].value = '';
                pinInputs[currentIndex].focus();
            }
        });
        
        // 添加删除按钮的触摸事件处理
        deleteBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // 防止触发mouse事件
            deleteBtn.classList.add('touch-active');
        });
        
        deleteBtn.addEventListener('touchend', (e) => {
            e.preventDefault(); // 防止触发mouse事件
            deleteBtn.classList.remove('touch-active');
            // 手动触发点击事件
            deleteBtn.click();
        });
        
        deleteBtn.addEventListener('touchcancel', () => {
            deleteBtn.classList.remove('touch-active');
        });
        
        // 输入框输入事件
        pinInputs.forEach((input, index) => {
            // 防止选中
            input.addEventListener('select', (e) => {
                e.preventDefault();
                input.blur();
                setTimeout(() => {
                    pinInputs[currentIndex].focus();
                }, 0);
            });
            
            // 防止通过点击改变焦点
            input.addEventListener('click', (e) => {
                e.preventDefault();
                pinInputs[currentIndex].focus();
            });
            
            // 防止通过触摸改变焦点
            input.addEventListener('touchstart', (e) => {
                e.preventDefault();
                pinInputs[currentIndex].focus();
            });
            
            input.addEventListener('input', () => {
                if (input.value && index < 5) {
                    currentIndex = index + 1;
                    pinInputs[currentIndex].focus();
                }
                if (index === 5 && input.value) {
                    handleLogin();
                }
            });
            
            // 焦点事件 - 确保焦点始终在当前应该输入的位置
            input.addEventListener('focus', (e) => {
                // 只有当点击的是当前应该输入的位置时，才更新currentIndex
                // 否则自动跳转到正确的位置
                if (index !== currentIndex) {
                    e.preventDefault();
                    input.blur();
                    setTimeout(() => {
                        pinInputs[currentIndex].focus();
                    }, 0);
                }
            });
            
            // 键盘事件
            input.addEventListener('keydown', (e) => {
                if (e.key >= '0' && e.key <= '9') {
                    e.preventDefault();
                    input.value = e.key;
                    if (index < 5) {
                        currentIndex = index + 1;
                        pinInputs[currentIndex].focus();
                    } else {
                        handleLogin();
                    }
                } else if (e.key === 'Backspace') {
                    e.preventDefault();
                    input.value = '';
                    if (index > 0) {
                        currentIndex = index - 1;
                        pinInputs[currentIndex].focus();
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    handleLogin();
                }
            });
        });
        
        // 处理登录
        async function handleLogin() {
            // 获取PIN码
            const pin = pinInputs.map(input => input.value).join('');
            
            // 验证PIN码
            if (pin.length !== 6 || !/^\d+$/.test(pin)) {
                return;
            }
            
            try {
                // 发送登录请求
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ room_id: pin })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // 登录成功，跳转到主页面
                    window.location.href = `/index`;
                } else {
                    // 显示错误信息
                    if (data.detail === '请求过于频繁，请稍后再试') {
                        rateLimitAlert.classList.add('show');
                        setTimeout(() => {
                            rateLimitAlert.classList.remove('show');
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('登录失败:', error);
            }
        }
    </script>
</body>
</html>